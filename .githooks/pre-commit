#!/bin/bash
#
# OpenSourceTree Pre-Commit Hook
#
# This hook runs before each commit to ensure code quality:
# 1. Formats code using dotnet format
# 2. Runs build with all analyzers enabled
# 3. Runs all tests
# 4. Auto-stages formatting changes
# 5. Blocks commit if build or tests fail
#

set -e

echo "ğŸ” Running pre-commit checks..."

# Get the list of staged C# files
STAGED_CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' || true)

if [ -z "$STAGED_CS_FILES" ]; then
    echo "â„¹ï¸  No C# files staged, skipping checks"
    exit 0
fi

echo ""
echo "ğŸ“ Step 1/3: Formatting code..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Run dotnet format on the entire solution
# --no-restore: Don't restore packages (faster)
# --verbosity quiet: Less output
if ! dotnet format OpenSourceTree.slnx --no-restore --verbosity quiet; then
    echo "âŒ Code formatting failed!"
    exit 1
fi

echo "âœ… Code formatted successfully"

# Check if formatting made any changes to staged files
MODIFIED_FILES=$(git diff --name-only $STAGED_CS_FILES || true)

if [ -n "$MODIFIED_FILES" ]; then
    echo ""
    echo "â„¹ï¸  Formatting changes detected in:"
    echo "$MODIFIED_FILES" | sed 's/^/   - /'
    echo ""
    echo "ğŸ”„ Auto-staging formatted files..."

    # Re-stage the formatted files
    for file in $STAGED_CS_FILES; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done

    echo "âœ… Formatted files re-staged"
fi

echo ""
echo "ğŸ”¨ Step 2/3: Building solution..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Build the solution with all analyzers enabled
if ! dotnet build OpenSourceTree.slnx --no-restore --nologo /clp:NoSummary 2>&1 | grep -E "(error|warning)" ; then
    # No errors or warnings found (grep returns non-zero when no matches)
    echo "âœ… Build succeeded with 0 errors and 0 warnings"
else
    echo ""
    echo "âŒ Build failed! Please fix the errors above before committing."
    echo ""
    echo "ğŸ’¡ Tip: Run 'dotnet build' to see full output"
    exit 1
fi

echo ""
echo "ğŸ§ª Step 3/3: Running tests..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Run all tests and capture output
# --no-build: Use already built assemblies
# --no-restore: Don't restore packages
# --verbosity normal: Show test results including failures
TEST_OUTPUT=$(dotnet test OpenSourceTree.slnx --no-build --no-restore --nologo --verbosity normal 2>&1)
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -eq 0 ]; then
    # Extract test summary (Passed/Failed/Skipped counts)
    echo "$TEST_OUTPUT" | grep -E "(Passed!|Total tests:|Test Run Successful)" || echo "âœ… All tests passed"
else
    # Tests failed - show the full output with failures
    echo "$TEST_OUTPUT"
    echo ""
    echo "âŒ Tests failed! Please fix the failing tests before committing."
    echo ""
    echo "ğŸ’¡ Tip: Run 'dotnet test --verbosity detailed' to see more information"
    exit 1
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… All pre-commit checks passed!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

exit 0
